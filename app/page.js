// same logic as previous fixed version (not rewritten here for brevity)